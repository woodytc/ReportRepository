/*
This software is allowed to use under GPL or you need to obtain Commercial or Enterprise License 
 to use it in non-GPL project. Please contact sales@webix.com for details
*/
webix.i18n.pivot={apply:"Apply",cancel:"Cancel",columns:"Columns",count:"count",fields:"Fields",filters:"Filters",max:"max",min:"min",operationNotDefined:"Operation is not defined",pivotMessage:"[Click to configure]",rows:"Rows",select:"select",sum:"sum",text:"text",values:"Values",windowMessage:"[move fields into required sector]"},webix.protoUI({name:"pivot",defaults:{fieldMap:{},yScaleWidth:300,columnWidth:150,filterLabelWidth:100},$divider:"_'_",$init:function(t){t.structure||(t.structure={}),webix.extend(t.structure,{rows:[],columns:[],values:[],filters:[]}),this.$view.className+=" webix_pivot",webix.extend(t,this.Ts(t)),this.$ready.push(this.render),this.data.attachEvent("onStoreUpdated",webix.bind(function(){this.$$("data")&&this.render()},this))},Ts:function(t){var e={id:"filters",view:"toolbar",hidden:!0,cols:[{}]},i={view:"treetable",id:"data",select:"row",navigation:!0,leftSplit:1,resizeColumn:!0,on:{onHeaderClick:function(t){0==this.getColumnIndex(t.column)&&this.getTopParentView().configure()}},columns:[{}]};return t.datatable&&"object"==typeof t.datatable&&(delete t.datatable.id,webix.extend(i,t.datatable,!0)),{rows:[e,i]}},configure:function(){if(!this.Us){var t={id:"popup",view:"webix_pivot_config",operations:[],pivot:this.config.id};webix.extend(t,this.config.popup||{}),this.Us=webix.ui(t),this.Us.attachEvent("onApply",webix.bind(function(t){this.define("structure",t),this.render()},this))}var e=[];for(var i in this.operations)e.push({name:i,title:this.Vs(i)});this.Us.define("operations",e);var s=webix.html.offset(this.$$("data").getNode());this.Us.setPosition(s.x+10,s.y+10),this.Us.define("data",this.getFields()),this.Us.show()},render:function(t){var e=this.Ws(this.data.pull,this.data.order);if(!t){var i=this.Xs();i.length>0?(this.$$("filters").show(),this.$$("filters").define("cols",i),this.Ys()):this.$$("filters").hide()}this.$$("data").config.columns=e.header,this.$$("data").refreshColumns(),this.$$("data").clearAll(),this.$$("data").parse(e.data)},toPDF:function(){this.$$("data").exportToPDF.apply(this.$$("data"),arguments)},toExcel:function(){this.$$("data").exportToExcel.apply(this.$$("data"),arguments)},Vs:function(t){return webix.i18n.pivot[t]||t},Zs:function(t){return this.config.fieldMap[t]||t},Xs:function(){for(var t=this.config.structure.filters||[],e=[],i=0;i<t.length;i++){var s=t[i],n={value:s.value,labelAlign:"right",label:this.Zs(s.name),labelWidth:this.config.filterLabelWidth,field:s.name,view:s.type};"select"==s.type&&(n.options=this.$s(s.name)),e.push(n)}return e},$s:function(t){var e=[{value:"",id:""}],i=this.data.pull,s={};for(var n in i){var r=i[n][t];webix.isUndefined(r)||s[r]||(e.push({value:r,id:r}),s[r]=!0)}return e},Ys:function(){var t=this.$$("filters");t.reconstruct();for(var e=t.getChildViews(),i=this,s=0;s<e.length;s++){var n=e[s];"select"==n.name?n.attachEvent("onChange",function(t){i._s(this.config.field,t)}):n.attachEvent("onTimedKeyPress",function(){i._s(n.config.field,n.getValue())})}},_s:function(t,e){for(var i=this.config.structure.filters,s=0;s<i.length;s++)if(i[s].name==t)return i[s].value=e,this.render(!0),!0;return!1},Ws:function(t,e){this.at();var i=this.config.structure;i.I=[],i.bt={};for(var s=0;s<i.values.length;s++)i.values[s].operation=i.values[s].operation||["sum"],webix.isArray(i.values[s].operation)||(i.values[s].operation=[i.values[s].operation]);var n=i.rows.concat(i.columns),r=this.ct(t,e,n),a={};return i.rows.length>0?r=this.dt(r,i.rows,i,a):(this.et(r,i.columns,i,a),r=[]),a=this.ft(a),{header:a,data:r}},ct:function(t,e,i){var s,n={};if(0==i.length)return n;for(var r=0;r<e.length;r++){var a=e[r];t[a]&&this.gt(t[a])&&(s=t[a][i[0]],webix.isUndefined(n[s])&&(n[s]={}),n[s][a]=t[a])}if(i.length>1)for(s in n)n[s]=this.ct(n[s],e,i.slice(1));return n},dt:function(t,e,i,s){var n=[];if(e.length>1){for(var r in t)t[r]=this.dt(t[r],e.slice(1),i,s);var a=i.I;for(var r in t){for(var h={data:t[r]},o=0;o<h.data.length;o++)for(var l=0;l<a.length;l++){var c=a[l];webix.isUndefined(h[c])&&(h[c]=[]),h[c].push(h.data[o][c])}h=this.ht(h,i),h=this.it(h,i),h.name=r,h.open=!0,n.push(h)}}else for(var r in t){var h=this.et(t[r],this.config.structure.columns,i,s);h.name=r,h=this.ht(h,i),h=this.it(h,i),n.push(h)}return n},et:function(t,e,i,s,n,r){if(n=n||{},e.length>0){r=r||"";for(var a in t)s[a]||(s[a]={}),t[a]=this.et(t[a],e.slice(1),i,s[a],n,(r.length>0?r+this.$divider:"")+a)}else if(!webix.isUndefined(r)){var h=this.config.structure.values;for(var o in t)for(var a=0;a<h.length;a++)for(var l=0;l<h[a].operation.length;l++){var c=r+this.$divider+h[a].operation[l]+this.$divider+h[a].name;i.bt[c]||(i.I.push(c),i.bt[c]=!0),webix.isUndefined(n[c])&&(n[c]=[],s[h[a].operation[l]+this.$divider+h[a].name]={}),n[c].push(t[o][h[a].name])}}return n},ft:function(t){t=this.jt(t);for(var e=0;e<t.length;e++){for(var i=[],s=0;s<t[e].length;s++)i.push(t[e][s].name);t[e]={id:i.join(this.$divider),header:t[e],sort:"int",width:this.config.columnWidth}}return t.splice(0,0,{id:"name",exportAsTree:!0,template:"{common.treetable()} #name#",header:{text:webix.i18n.pivot.pivotMessage},width:this.config.yScaleWidth}),t},jt:function(t){var e=[];for(var i in t){var s=!0;for(var n in t[i]){s=!1;break}if(s){var r=i.split(this.$divider);r.length>1?e.push([{name:i,text:this.Zs(r[1])+" ("+this.Vs(r[0])+")"}]):e.push([{name:i,text:i}])}else{t[i]=this.jt(t[i]);for(var a=!1,h=0;h<t[i].length;h++){var o=t[i][h];o.splice(0,0,{name:i,text:i}),a||(o[0].colspan=t[i].length,a=!0),e.push(o)}}}return e},ht:function(t,e){for(var i=0;i<e.I.length;i++){var s=e.I[i],n=s.split(this.$divider),r=n[n.length-2];t[s]=t[s]?this.operations[r].call(this,t[s]):"",t[s]=Math.round(1e5*t[s])/1e5}return t},it:function(t,e){if(!this.config.min&&!this.config.max)return t;var i=this.config.structure.values;t.$cellCss||(t.$cellCss={});for(var s=0;s<i.length;s++){for(var n=i[s],r=[],a=-99999999,h=[],o=99999999,l=0;l<e.I.length;l++){var c=e.I[l];window.isNaN(t[c])||-1!==c.indexOf(n.name,this.length-n.name.length)&&(this.config.max&&t[c]>a?(r=[c],a=t[c]):t[c]==a&&r.push(c),this.config.min&&t[c]<o?(h=[c],o=t[c]):t[c]==o&&h.push(c))}for(var l=0;l<h.length;l++)t.$cellCss[h[l]]="webix_min";for(var l=0;l<r.length;l++)t.$cellCss[r[l]]="webix_max"}return t},operations:{sum:function(t){for(var e=0,i=0;i<t.length;i++){var s=t[i];s=parseFloat(s,10),window.isNaN(s)||(e+=t[i])}return e},count:function(t){return t.length},max:function(t){return 1==t.length?t[0]:Math.max.apply(this,t)},min:function(t){return 1==t.length?t[0]:Math.min.apply(this,t)}},getFields:function(){for(var t=[],e={},i=0;i<Math.min(this.data.count()||5);i++){var s=this.data.getItem(this.data.getIdByIndex(i));for(var n in s)e[n]||(t.push(n),e[n]=webix.uid())}for(var r=this.config.structure,a={fields:[],rows:[],columns:[],values:[],filters:[]},i=0;i<r.rows.length;i++){var n=r.rows[i];webix.isUndefined(e[n])||(a.rows.push({name:n,text:this.Zs(n),id:e[n]}),delete e[n])}for(var i=0;i<r.columns.length;i++){var n=r.columns[i];webix.isUndefined(e[n])||(a.columns.push({name:n,text:this.Zs(n),id:e[n]}),delete e[n])}for(var i=0;i<r.values.length;i++){var n=r.values[i];if(!webix.isUndefined(e[n.name])){var h=this.Zs(n.name);a.values.push({name:n.name,text:h,operation:n.operation,id:e[n.name]})}}for(var i=0;i<(r.filters||[]).length;i++){var n=r.filters[i];if(!webix.isUndefined(e[n.name])){var h=this.Zs(n.name);a.filters.push({name:n.name,text:h,type:n.type,value:n.value,id:e[n]}),delete e[n.name]}}for(var i=0;i<t.length;i++){var n=t[i];webix.isUndefined(e[n])||a.fields.push({name:n,text:this.Zs(n),id:e[n]})}return a},at:function(){for(var t=this.config.structure.filters||[],e=0;e<t.length;e++){var i=t[e],s=(i.value||"").trim();"="==s.substr(0,1)?(i.func=this.filters.equals,s=s.substr(1)):">="==s.substr(0,2)?(i.func=this.filters.more_equals,s=s.substr(2)):">"==s.substr(0,1)?(i.func=this.filters.more,s=s.substr(1)):"<="==s.substr(0,2)?(i.func=this.filters.less_equals,s=s.substr(2)):"<"==s.substr(0,1)?(i.func=this.filters.less,s=s.substr(1)):i.func=this.filters.contains,i.fvalue=s}},gt:function(t){for(var e=this.config.structure.filters||[],i=0;i<e.length;i++){var s=e[i];if(""!=s.fvalue){if(webix.isUndefined(t[s.name]))return!1;var n=t[s.name].toString().toLowerCase(),r=s.func.call(this.filters,s.fvalue,n);if(!r)return!1}}return!0},filters:{kt:function(t,e,i){return t=window.parseFloat(t,10),e=window.parseFloat(e,10),window.isNaN(t)?!0:window.isNaN(e)?!1:i(t,e)},contains:function(t,e){return e.indexOf(t.toString().toLowerCase())>=0},equals:function(t,e){return this.kt(t,e,function(t,e){return t==e})},more:function(t,e){return this.kt(t,e,function(t,e){return e>t})},more_equals:function(t,e){return this.kt(t,e,function(t,e){return e>=t})},less:function(t,e){return this.kt(t,e,function(t,e){return t>e})},less_equals:function(t,e){return this.kt(t,e,function(t,e){return t>=e})}},getStructure:function(){return this.config.structure},getConfigWindow:function(){return this.Us},profile_setter:function(t){var e=console;t&&(this.attachEvent("onBeforeLoad",function(){e.time("data loading")}),this.data.attachEvent("onParse",function(){e.timeEnd("data loading"),e.time("data parsing")}),this.data.attachEvent("onStoreLoad",function(){e.timeEnd("data parsing"),e.time("data processing")}),this.$ready.push(function(){this.$$("data").attachEvent("onBeforeRender",function(){this.count()&&(e.timeEnd("data processing"),e.time("data rendering"))}),this.$$("data").attachEvent("onAfterRender",function(){this.count()&&webix.delay(function(){e.timeEnd("data rendering")})})}))}},webix.IdSpace,webix.ui.layout,webix.DataLoader,webix.EventSystem,webix.Settings),webix.protoUI({name:"webix_pivot_config",$init:function(t){this.$view.className+=" webix_popup webix_pivot",webix.extend(t,this.defaults),webix.extend(t,this.Ts(t)),this.$ready.push(this.lt)},defaults:{padding:8,height:420,width:600,cancelButtonWidth:100,applyButtonWidth:100,fieldsColumnWidth:130,head:!1,modal:!0,move:!0},Ts:function(t){return{head:{view:"toolbar",cols:[{id:"config_title",data:{value:"windowMessage"},css:"webix_pivot_transparent",borderless:!0,template:this.mt.popupHeaders},{view:"button",id:"cancel",type:"iconButton",icon:"times",label:webix.i18n.pivot.cancel,width:t.cancelButtonWidth},{view:"button",id:"apply",type:"iconButton",icon:"check",css:"webix_pivot_apply",label:webix.i18n.pivot.apply,width:t.applyButtonWidth}]},body:{type:"wide",rows:[{type:"wide",margin:5,cols:[{width:t.fieldsColumnWidth,rows:[{id:"fieldsHeader",data:{value:"fields"},template:this.mt.popupHeaders,type:"header"},{id:"fields",view:"list",scroll:!1,type:{height:35},drag:!0,template:"<span class='webix_pivot_list_marker'></span>#text#",on:{onBeforeDropOut:webix.bind(this.nt,this)}}]},{view:"resizer"},{cols:[{rows:[{id:"filtersHeader",data:{value:"filters"},template:this.mt.popupIconHeaders,type:"header"},{id:"filters",view:"list",scroll:!1,type:"PivotList",drag:!0,css:"webix_pivot_values",template:function(t){return t.type=t.type||"select","<a class='webix_pivot_link'>"+t.text+" <span class='webix_link_selection'>"+t.type+"</span></a> "},type:{height:35},onClick:{webix_pivot_link:webix.bind(this.ot,this)}},{id:"rowsHeader",data:{value:"rows"},template:this.mt.popupIconHeaders,type:"header"},{id:"rows",view:"list",type:"PivotList",scroll:!1,drag:!0,template:"#text#",type:{height:35}}]},{rows:[{id:"columnsHeader",data:{value:"columns"},template:this.mt.popupIconHeaders,type:"header"},{id:"columns",view:"list",type:"PivotList",scroll:!1,drag:!0,type:{height:35},template:"#text#"},{id:"valuesHeader",data:{value:"values"},template:this.mt.popupIconHeaders,type:"header"},{id:"values",view:"list",scroll:!0,drag:!0,css:"webix_pivot_values",type:{height:"auto"},template:webix.bind(this.pt,this),onClick:{webix_pivot_link:webix.bind(this.qt,this),webix_pivot_plus:webix.bind(this.rt,this),webix_pivot_minus:webix.bind(this.st,this)},on:{onBeforeDrop:webix.bind(this.tt,this),onBeforeDropOut:webix.bind(this.nt,this)}}]}]}]}]}}},mt:{popupHeaders:function(t){return webix.i18n.pivot[t.value]},popupIconHeaders:function(t){return"<span class='webix_pivot_popup_icon "+t.value+"'></span>"+webix.i18n.pivot[t.value]}},nt:function(t){if(t.to!=t.from){var e=t.source[0];t.from==this.$$("values")?this.$$("fields").getItem(e)&&this.$$("fields").remove(e):t.from==this.$$("fields")&&t.to!=this.$$("values")&&this.$$("values").getItem(e)&&this.$$("values").remove(e)}},tt:function(t){if(t.to&&t.from!=t.to){var e=t.source,i=t.from.getItem(e);if(t.from==this.$$("fields"))return t.to.getItem(e)?this.rt({},e):t.to.add(webix.copy(i),t.index),!1;this.$$("fields").getItem(e)||this.$$("fields").add(webix.copy(i))}return!0},lt:function(){this.attachEvent("onItemClick",function(t){"button"==this.$eventSource.name&&(this.callEvent("on"+this.innerId(t),[this.getStructure()]),this.hide())})},pt:function(t){t.operation=t.operation||["sum"],webix.isArray(t.operation)||(t.operation=[t.operation]);for(var e=[],i=$$(this.config.pivot).Vs,s=0;s<t.operation.length;s++){var n="<span class='webix_pivot_link' webix_operation='"+s+"'>";n+="<span>"+t.text+"</span>",n+="<span class='webix_link_selection'>"+i(t.operation[s])+"</span>",n+="<span class='webix_pivot_minus webix_icon fa-times'></span>",n+="</span>",e.push(n)}return e.join(" ")},qt:function(t,e){var i={view:"webix_pivot_popup",autofit:!0,height:150,width:150,data:this.config.operations||[]},s=webix.ui(i);s.show(t),s.attachEvent("onHide",webix.bind(function(){var i=webix.html.locate(t,"webix_operation"),n=s.getSelected();null!==n&&(this.$$("values").getItem(e).operation[i]=n.name,this.$$("values").updateItem(e)),s.close()},this))},rt:function(t,e){var i=this.$$("values").getItem(e);i.operation.push("sum"),this.$$("values").updateItem(e),webix.delay(function(){for(var t=i.operation.length-1,s=this.$$("values").getItemNode(e).childNodes,n=null,r=0;r<s.length;r++)if(n=s[r],n.getAttribute){var a=n.getAttribute("webix_operation");if(!webix.isUndefined(a)&&a==t)break}null!==n&&this.qt(n,e)},this)},st:function(t,e){var i=webix.html.locate(t,"webix_operation"),s=this.$$("values").getItem(e);return s.operation.length>1?(s.operation.splice(i,1),this.$$("values").updateItem(e)):this.$$("values").remove(e),!1},ot:function(t,e){var i=$$(this.config.pivot).Vs,s={view:"webix_pivot_popup",autofit:!0,height:150,width:150,data:[{name:"select",title:i("select")},{name:"text",title:i("text")}]},n=webix.ui(s);n.show(t),n.attachEvent("onHide",webix.bind(function(){var t=n.getSelected();if(null!==t){var i=this.$$("filters").getItem(e);i.type=t.name,this.$$("filters").updateItem(e)}n.close()},this))},data_setter:function(t){this.$$("fields").clearAll(),this.$$("fields").parse(t.fields),this.$$("filters").clearAll(),this.$$("filters").parse(t.filters),this.$$("columns").clearAll(),this.$$("columns").parse(t.columns),this.$$("rows").clearAll(),this.$$("rows").parse(t.rows),this.$$("values").clearAll(),this.$$("values").parse(t.values)},setStructure:function(t){this.define("structure",t),this.render()},getStructure:function(){var t={rows:[],columns:[],values:[],filters:[]},e=this.$$("rows");e.data.each(function(e){t.rows.push(e.name)});var i=this.$$("columns");i.data.each(function(e){t.columns.push(e.name)});var s=this.$$("values");s.data.each(function(e){t.values.push(e)});var n=this.$$("filters");return n.data.each(function(e){t.filters.push(e)}),t}},webix.ui.window,webix.IdSpace),webix.protoUI({name:"webix_pivot_popup",xg:null,$init:function(t){webix.extend(t,this.Ts(t)),this.$ready.push(this.lt)},Ts:function(t){return{body:{id:"list",view:"list",scroll:!1,autoheight:!0,template:"#title#",data:t.data}}},lt:function(){this.attachEvent("onItemClick",function(t){this.xg=this.$eventSource.getItem(t),this.hide()})},getSelected:function(){return this.xg}},webix.ui.popup,webix.IdSpace);